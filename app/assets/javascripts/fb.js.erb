var locations = {};
function main() {
	<% Settings.reload! %>

	// get friends' locations
	console.log('getting friends locations');
	//document.getElementById("progress_count").style.visibility = 'visible';
	
   	FB.getLoginStatus(function(loginStatusResponse) {
		var access_token = loginStatusResponse.authResponse.accessToken;
		var query = 'SELECT uid, name, pic_square, current_location FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) AND current_location != \'\'';
		var url = encodeURI('https://graph.facebook.com/fql?q=' + query + '&access_token=' + access_token);
		
		//document.getElementById("total_friends").innerHTML = <%= Settings.friends_list_length %>;		
		
		$.get(url).complete(function(resp) { 
			data = JSON.parse(resp.responseText).data;

			for (var i=0; i < data.length; i++) {
				uid = data[i].uid;
				name = data[i].name;
				pic = data[i].pic_square;
				city = data[i].current_location.name;
				
				var userInfo = {};
				userInfo.uid = uid;
				userInfo.name = name;
				userInfo.pic = pic;
				userInfo.city = city;
				
				var userInfoList;
				if (locations[city] !== undefined) {
					// retrieve list of users first
					userInfoList = locations[city];
				}
				else {
					userInfoList = [];
				}

				userInfoList.push(userInfo);
				locations[city] = userInfoList;				
			}
			
			addMarkersForLocations(locations);
		});		
	});
}